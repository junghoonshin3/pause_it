default_platform(:android)

platform :android do
  # Firebase ë°°í¬ í•¨ìˆ˜ (ê¸°ì¡´)
  def deploy_to_firebase(flavor)
    # 1. ë¹Œë“œ (Flutter ëª…ë ¹ì–´ë¡œ ì‹¤í–‰ - .env íŒŒì¼ì—ì„œ í™˜ê²½ë³€ìˆ˜ ë¡œë“œ)
    sh("flutter build apk --release --flavor #{flavor} -t lib/main_#{flavor}.dart")

    # 2. Firebase ì—…ë¡œë“œ
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID_#{flavor.upcase}"], # í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©
      service_credentials_file: "firebase_credentials.json",
      groups: "testers",
      android_artifact_path: "../build/app/outputs/flutter-apk/app-#{flavor}-release.apk"
    )
  end

  # Google Play Console ë°°í¬ í•¨ìˆ˜ (ì‹ ê·œ)
  def deploy_to_play_console(flavor)
    # 1. AAB ë¹Œë“œ (Play Console í•„ìˆ˜)
    sh("flutter build appbundle --release --flavor #{flavor} -t lib/main_#{flavor}.dart")

    # 2. Play Console ì—…ë¡œë“œ
    upload_to_play_store(
      track: "alpha",  # Closed Testing íŠ¸ë™
      aab: "../build/app/outputs/bundle/#{flavor}Release/app-#{flavor}-release.aab",
      json_key: "google_play_credentials.json",
      skip_upload_screenshots: true,
      skip_upload_images: true,
      skip_upload_metadata: false,
      release_status: "draft"  # Draft ìƒíƒœë¡œ ì—…ë¡œë“œ (ìˆ˜ë™ ê²€í† )
    )

    UI.success("ğŸ‰ Google Play Console Closed Testing ì—…ë¡œë“œ ì™„ë£Œ!")
    UI.message("ğŸ“ Play Consoleì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ê²€í†  í›„ ë°°í¬í•˜ì„¸ìš”.")
  end

  # Dev Lane (ê¸°ì¡´ ìœ ì§€)
  lane :dev do
    deploy_to_firebase("dev")
  end

  # Prod Lane (Play Consoleë¡œ ë³€ê²½)
  lane :prod do
    deploy_to_play_console("prod")
  end
end